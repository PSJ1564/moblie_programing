package com.example.pineapplegame;

import android.content.SharedPreferences;
import android.graphics.Color;
import android.graphics.drawable.AnimationDrawable;
import android.graphics.drawable.ColorDrawable;
import android.media.AudioAttributes;
import android.media.SoundPool;
import android.os.Bundle;
import android.os.CountDownTimer;
import android.os.Handler;
import android.util.Log;
import android.view.Gravity;
import android.view.MotionEvent;
import android.view.View;
import android.view.animation.DecelerateInterpolator;
import android.widget.Button;
import android.widget.FrameLayout;
import android.widget.GridLayout;
import android.widget.LinearLayout;
import android.widget.TextView;
import android.widget.Toast;

import androidx.annotation.NonNull;
import androidx.appcompat.app.AppCompatActivity;

import com.google.android.material.snackbar.Snackbar;
import com.google.firebase.database.DataSnapshot;
import com.google.firebase.database.DatabaseError;
import com.google.firebase.database.DatabaseReference;
import com.google.firebase.database.FirebaseDatabase;
import com.google.firebase.database.ValueEventListener;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Random;
import java.util.UUID;

public class GameActivity extends AppCompatActivity {
    private static final int GRID_ROWS = 12;
    private static final int GRID_COLS = 8;
    private GridLayout gridLayout;
    private LinearLayout state;
    private FrameLayout root;//id:main rootviewÏûÑ
    private TextView[][] appleCells = new TextView[GRID_ROWS][GRID_COLS];
    private Random random = new Random();
    private View scoreOverlay;
    private TextView textFinalScore;

    private int cellSize = 110;

    private int startRow = -1, startCol = -1;

    // ÌÉÄÏù¥Î®∏ Î∞è Ï†êÏàò Í¥ÄÎ†®
    private TextView textTimer, textScore;
    private CountDownTimer countDownTimer, comboTimer;
    private int score = 0;
    private int comboScore = 0;
    private long remainingTime = 0;
    private final long totalTime = 60 * 1000; // 120Ï¥à
    private Button btnHint; //ÌûåÌä∏
    private int hintCount = 3; // ÌûåÌä∏
    private int destroyCount = 3;
    private int swapCount = 3;
    private enum Mode { NORMAL, DESTROY, SWAP }
    private Mode currentMode = Mode.NORMAL;
    private boolean isDestroyedMode = false;
    private boolean isSwapMode = false;
    private boolean isFirstSwapSelected = false;
    private boolean running = true;
    private boolean combo = false;
    private int firstSwapRow, firstSwapCol;
    private Button btnPause, btnReturn, btnDestroy, btnSwap;
    private SoundPool soundPool;
    private int soundExplosion, soundDragId;
    private long lastPlayedTime = 0;
    private int prevSelectedCount = -1;
    private boolean isExplosionInProgress = false;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_game); // ‚úÖ ÏàòÏ†ïÎêú Î†àÏù¥ÏïÑÏõÉ ÏÇ¨Ïö©
        root = findViewById(R.id.root);
        state = findViewById(R.id.state);
        gridLayout = findViewById(R.id.gridLayout);
        textTimer = findViewById(R.id.textTimer);
        textScore = findViewById(R.id.textScore);
        btnPause = findViewById(R.id.btnPause);
        btnReturn = findViewById(R.id.btnReturn);
        scoreOverlay = findViewById(R.id.scoreOverlay);
        textFinalScore = findViewById(R.id.textFinalScore);
        btnDestroy = findViewById(R.id.btnDestroy);
        btnSwap = findViewById(R.id.btnSwap);
        btnHint = findViewById(R.id.btnHint); // ÌûåÌä∏ Ïó∞Í≤∞
        updateHintButtonText();

        btnHint.setOnClickListener(v -> {
            if (hintCount > 0) {
                hintCount--;
                updateHintButtonText();
                showHint(); // ÌûåÌä∏ ÌëúÏãú Ìï®Ïàò Ìò∏Ï∂ú
                if (hintCount == 0) {
                    Toast.makeText(this, "üí° ÌûåÌä∏ Î™®Îëê ÏÇ¨Ïö©!", Toast.LENGTH_SHORT).show();
                }
            }
        });
        btnPause.setOnClickListener(v -> {
            if(running) {
                pauseTimer();
                btnPause.setText("Ïû¨ÏãúÏûë");
                btnReturn.setVisibility(View.VISIBLE);
            }
            else {
                resumeTimer();
                btnPause.setText("ÏùºÏãúÏ†ïÏßÄ");
                btnReturn.setVisibility(View.INVISIBLE);
            }

        });

        setupReturnButton();
        setupItemButton();
        createAppleGrid();
        setTouchListener();
        startTimer();
        SharedPreferences prefs = getSharedPreferences("game_prefs", MODE_PRIVATE);
        boolean isItemMode = prefs.getBoolean("item_mode", false);
        AudioAttributes audioAttributes = new AudioAttributes.Builder()
                .setUsage(AudioAttributes.USAGE_GAME)
                .setContentType(AudioAttributes.CONTENT_TYPE_SONIFICATION)
                .build();

        soundPool = new SoundPool.Builder()
                .setMaxStreams(4)
                .setAudioAttributes(audioAttributes)
                .build();
        soundExplosion = soundPool.load(this, R.raw.low_pop, 1);
        soundDragId = soundPool.load(this, R.raw.drag, 1);

        if (!isItemMode) {
            // ÏïÑÏù¥ÌÖú UIÎßå Ïà®ÍπÄ
            btnDestroy.setVisibility(View.GONE);
            btnSwap.setVisibility(View.GONE);
            btnHint.setVisibility(View.GONE);
        }
    }
    private void createAppleGrid() {
        gridLayout.removeAllViews();

        for (int row = 0; row < GRID_ROWS; row++) {
            for (int col = 0; col < GRID_COLS; col++) {
                TextView cell = new TextView(this);
                int value = random.nextInt(9) + 1;
                cell.setText(String.valueOf(value));
                cell.setGravity(Gravity.CENTER);
                cell.setTextSize(18);
                cell.setTextColor(Color.BLACK);
                cell.setBackgroundResource(R.drawable.pineapple_grid);
                cell.setPadding(0,20,0,0);

                GridLayout.LayoutParams params = new GridLayout.LayoutParams();
                params.width = cellSize;
                params.height = cellSize;
                params.rowSpec = GridLayout.spec(row);
                params.columnSpec = GridLayout.spec(col);
                params.setMargins(4, 4, 4, 4);

                cell.setLayoutParams(params);
                gridLayout.addView(cell);
                appleCells[row][col] = cell;
            }
        }
    }

    private void highlightSelection(int r1, int c1, int r2, int c2) {
        if (isExplosionInProgress) return;

        clearHighlight();

        int top = Math.min(r1, r2);
        int bottom = Math.max(r1, r2);
        int left = Math.min(c1, c2);
        int right = Math.max(c1, c2);

        int selectedCount = 0;

        for (int row = top; row <= bottom; row++) {
            for (int col = left; col <= right; col++) {
                if (!appleCells[row][col].getText().toString().isEmpty()) {
                    appleCells[row][col].setBackgroundResource(R.drawable.pineapple_gridselect);
                    selectedCount++;
                }
            }
        }

        SharedPreferences prefs = getSharedPreferences("MusicPrefs", MODE_PRIVATE);
        if (prefs.getBoolean("isSoundEnabled", true) && selectedCount != prevSelectedCount) {
            float pitch = Math.min(2.5f, 1.5f + 0.1f * (Math.abs(r2 - r1) + Math.abs(c2 - c1) + 1));
            soundPool.play(soundDragId, 1f, 1f, 0, 0, pitch);
            prevSelectedCount = selectedCount;
        }
    }


    private void clearHighlight() {
        if (isExplosionInProgress) return;
        for (int row = 0; row < GRID_ROWS; row++) {
            for (int col = 0; col < GRID_COLS; col++) {
                String text = appleCells[row][col].getText().toString();
                if (!text.isEmpty()) {
                    appleCells[row][col].setBackgroundResource(R.drawable.pineapple_grid);
                } else {
                    appleCells[row][col].setBackgroundResource(R.drawable.pineapple_griddestroy);
                }
            }
        }
    }


    private void setTouchListener() {
        gridLayout.setOnTouchListener(new View.OnTouchListener() {
            @Override
            public boolean onTouch(View view, MotionEvent event) {
                int[] gridLocation = new int[2];
                gridLayout.getLocationOnScreen(gridLocation);

                int gridX = (int) event.getRawX() - gridLocation[0];
                int gridY = (int) event.getRawY() - gridLocation[1];

                int gridWidth = gridLayout.getWidth();
                int gridHeight = gridLayout.getHeight();
                int cellWidth = gridWidth / GRID_COLS;
                int cellHeight = gridHeight / GRID_ROWS;

                int col = (int)(gridX / (cellWidth-4));
                int row = (int)(gridY / (cellHeight-4));

                Log.d("TouchDebug", "gridLayout H: " + gridLayout.getHeight() + ", W: " + gridLayout.getWidth());
                Log.d("TouchDebug", "TouchX: " + gridX + ", TouchY: " + gridY);
                Log.d("TouchDebug", "Computed Row: " + row + ", Col: " + col);
                if (row >= GRID_ROWS || col >= GRID_COLS || row < 0 || col < 0)
                    return false;

                switch (event.getAction()) {
                    case MotionEvent.ACTION_DOWN:
                        startRow = row;
                        startCol = col;
                        if (isDestroyedMode) {
                            destroySelectedBlock(row, col);
                            isDestroyedMode = false;
                        } else if (isSwapMode) {
                            handleSwapBlock(row, col);
                        }
                        break;

                    case MotionEvent.ACTION_MOVE:
                        highlightSelection(startRow, startCol, row, col);
                        break;

                    case MotionEvent.ACTION_UP:
                        int endRow = row;
                        int endCol = col;
                        clearHighlight();
                        checkAndClearGroup(startRow, startCol, endRow, endCol);
                        break;
                }
                return true;
            }
        });

    }

    private void checkAndClearGroup(int r1, int c1, int r2, int c2) {
        int top = Math.min(r1, r2);
        int bottom = Math.max(r1, r2);
        int left = Math.min(c1, c2);
        int right = Math.max(c1, c2);

        int sum = 0;
        for (int row = top; row <= bottom; row++) {
            for (int col = left; col <= right; col++) {
                String text = appleCells[row][col].getText().toString();
                if (!text.isEmpty()) {
                    sum += Integer.parseInt(text);
                }
            }
        }

        if (sum == 10) {
            combo = true;
            for (int row = top; row <= bottom; row++) {
                for (int col = left; col <= right; col++) {
                    appleCells[row][col].setText("");
                    appleCells[row][col].setBackgroundResource(R.drawable.pineapple_griddestroy);
                }
            }
            startComboTimer();
            if(combo) {
                comboScore++;
                score += comboScore;
                textScore.setText("Score: " + score);
                if(comboScore > 1) {
                    Toast.makeText(this, "üî•ÏΩ§Î≥¥! x" + comboScore, Toast.LENGTH_SHORT).show();

                    // ‚è± 2Ï¥à Ï∂îÍ∞Ä
                    remainingTime += 2000;

                    // ‚úÖ Ï¶âÏãú UI ÎèôÍ∏∞Ìôî (Ï§ëÏöî!)
                    long seconds = remainingTime / 1000;
                    textTimer.setText("Time: " + seconds);

                    // üîÅ ÌÉÄÏù¥Î®∏ Ïû¨ÏãúÏûë
                    if (countDownTimer != null) {
                        countDownTimer.cancel();
                    }
                    resumeTimer();
                }
            }
            else {
                comboScore = 0;
                score++;
                textScore.setText("Score: " + score);
            }
        }
        else {
            combo = false;
            comboScore = 0;
        }
    }

    private void startComboTimer() {
        if (comboTimer != null) {
            comboTimer.cancel();
        }

        combo = true;
        comboTimer = new CountDownTimer(3000, 1000) {
            @Override
            public void onTick(long millisUntilFinished) {
                // ÏΩ§Î≥¥ ÌÉÄÏù¥Î®∏Îäî UIÏóê ÌëúÏãúÌïòÏßÄ ÏïäÏùå
            }

            @Override
            public void onFinish() {
                combo = false;
                comboScore = 0;
            }
        };
        comboTimer.start();
    }
    private void startTimer() {
        running = true;
        remainingTime = totalTime;
        countDownTimer = new CountDownTimer(totalTime, 1000) {
            @Override
            public void onTick(long millisUntilFinished) {
                remainingTime = millisUntilFinished;
                textTimer.setText("Time: " + millisUntilFinished / 1000);
                int color = 0xffd1f06a; //ÏãúÍ∞ÑÏóê Îî∞Î•∏ ÏÉÅÌÉúÌëúÏãúÏ§ÑÏÉâÏÉÅÎ≥ÄÍ≤Ω
                color = (int) ((color & 0xFF000000) |
                        (Math.min(255, ((color >> 16) & 0xFF) + 2*(60-millisUntilFinished/1000)) << 16) |
                        (Math.max(0, ((color >> 8) & 0xFF) - (60-millisUntilFinished/1000)) << 8) |
                        (Math.max(0, (color & 0xFF) - 2*(60-millisUntilFinished/1000))));
                state.setBackgroundColor(color);
            }

            @Override
            public void onFinish() {
                textTimer.setText("Time: 0");
                gridLayout.setEnabled(false);

                textFinalScore.setText("Score: " + score);
                scoreOverlay.setVisibility(View.VISIBLE);//Í≤åÏûÑÏ¢ÖÎ£åÏóê Îî∞Î•∏ Ï†êÏàòÏä§ÌÅ¨Î¶∞
                scoreOverlay.setBackgroundColor(Color.parseColor("#AAFFFFFF"));
                textFinalScore.setTextColor(Color.BLACK);
                scoreOverlay.setTranslationY(-1000);
                scoreOverlay.animate()
                        .translationY(0)
                        .setDuration(600)
                        .setInterpolator(new DecelerateInterpolator())
                        .start();
                btnReturn.setVisibility(View.VISIBLE);
                btnPause.setVisibility(View.GONE);
                btnDestroy.setVisibility(View.GONE);
                btnSwap.setVisibility(View.GONE);
                btnHint.setVisibility(View.GONE);
                gridLayout.setEnabled(false);
                running = false;
                // Ï†êÏàò Ï†ÄÏû•
                ScoreDatabaseHelper dbHelper = new ScoreDatabaseHelper(GameActivity.this);
                dbHelper.addScore(score);
                SharedPreferences prefs = getSharedPreferences("UserPrefs", MODE_PRIVATE);
                String nickname = prefs.getString("nickname", "Noname"); // Í∏∞Î≥∏Í∞íÏùÄ "Noname"
                Log.d("ScoreUpload", "Uploading score. Nickname: " + nickname + ", Score: " + score);
                uploadScoreWithLimit(nickname, score);
            }
        };
        countDownTimer.start();
    }
    private void pauseTimer() {
        if (countDownTimer != null) {
            countDownTimer.cancel();
            running = false;
        }
    }
    private void resumeTimer() {
        running = true;
        countDownTimer = new CountDownTimer(remainingTime, 1000) {
            @Override
            public void onTick(long millisUntilFinished) {
                remainingTime = millisUntilFinished;
                textTimer.setText("Time: " + millisUntilFinished / 1000);
            }

            @Override
            public void onFinish() {
                textTimer.setText("Time: 0");
                gridLayout.setEnabled(false);

                textFinalScore.setText("Score: " + score);
                scoreOverlay.setVisibility(View.VISIBLE);//Í≤åÏûÑÏ¢ÖÎ£åÏóê Îî∞Î•∏ Ï†êÏàòÏä§ÌÅ¨Î¶∞
                scoreOverlay.setBackgroundColor(Color.parseColor("#AAFFFFFF"));
                textFinalScore.setTextColor(Color.BLACK);
                scoreOverlay.setTranslationY(-1000);
                scoreOverlay.animate()
                        .translationY(0)
                        .setDuration(600)
                        .setInterpolator(new DecelerateInterpolator())
                        .start();
                btnReturn.setVisibility(View.VISIBLE);
                btnPause.setVisibility(View.GONE);
                btnDestroy.setVisibility(View.GONE);
                btnSwap.setVisibility(View.GONE);
                btnHint.setVisibility(View.GONE);
                gridLayout.setEnabled(false);
                running = false;
                // Ï†êÏàò Ï†ÄÏû•
                ScoreDatabaseHelper dbHelper = new ScoreDatabaseHelper(GameActivity.this);
                dbHelper.addScore(score);
                SharedPreferences prefs = getSharedPreferences("UserPrefs", MODE_PRIVATE);
                String nickname = prefs.getString("nickname", "Noname"); // Í∏∞Î≥∏Í∞íÏùÄ "Noname"
                uploadScoreWithLimit(nickname, score);
            }
        };
        countDownTimer.start();
    }
    private void setupReturnButton() {
        Button btnReturn = findViewById(R.id.btnReturn);
        btnReturn.setVisibility(View.INVISIBLE);
        btnReturn.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                finish();
            }
        });
    }

    private void setupItemButton() {
        btnDestroy.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                if(destroyCount > 0) {
                    isDestroyedMode = true;
                    Toast.makeText(GameActivity.this, "üß®Î∏îÎ°ù Ï†úÍ±∞ ÏïÑÏù¥ÌÖú ÏÇ¨Ïö©: Ï†úÍ±∞Ìï† Î∏îÎ°ùÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî!", Toast.LENGTH_SHORT).show();
                    //Snackbar.make(root, "ÌïúÏàúÍ∞ÑÎßå!", Snackbar.LENGTH_SHORT).setDuration(500).show(); //Tag:Suggest Ï†úÏïàÏÇ¨Ìï≠ Toast messageÍ∞Ä ÎÑàÎ¨¥ Í∏¥ Í≤É Í∞ôÏúºÎØÄÎ°ú ÏãúÍ∞ÑÏùÑ Ï°∞Ï†àÌï† Ïàò ÏûàÎäî snackbar Ï†úÏïà
                } else {
                    Toast.makeText(GameActivity.this, "‚ùåÎ∏îÎ°ù Ï†úÍ±∞ ÏïÑÏù¥ÌÖú ÏóÜÏùå.", Toast.LENGTH_SHORT).show();
                    btnDestroy.setVisibility(View.INVISIBLE);
                }
            }
        });

        btnSwap.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                if(swapCount > 0) {
                    isSwapMode = true;
                    isFirstSwapSelected = false;
                    Toast.makeText(GameActivity.this, "üîÑÎ∏îÎ°ù ÍµêÌôò ÏïÑÏù¥ÌÖú ÏÇ¨Ïö©: Ï≤´ Î≤àÏß∏ Î∏îÎ°ùÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî!", Toast.LENGTH_SHORT).show();
                } else {
                    Toast.makeText(GameActivity.this, "‚ùåÎ∏îÎ°ù ÍµêÌôò ÏïÑÏù¥ÌÖú ÏóÜÏùå.", Toast.LENGTH_SHORT).show();
                    btnSwap.setVisibility(View.INVISIBLE);
                }
            }
        });
    }

    private void destroySelectedBlock(int row, int col) {
        if (isExplosionInProgress) return; // Ï§ëÎ≥µ Î∞©ÏßÄ

        isExplosionInProgress = true;
        appleCells[row][col].setBackgroundResource(R.drawable.explosion_frame);  // Ïï†ÎãàÎ©îÏù¥ÏÖò ÎåÄÏã† Îã®Ïùº Ïù¥ÎØ∏ÏßÄ
        appleCells[row][col].setText("");
        destroyCount--;

        SharedPreferences prefs = getSharedPreferences("MusicPrefs", MODE_PRIVATE);
        boolean isSoundEnabled = prefs.getBoolean("isSoundEnabled", true);
        if (isSoundEnabled) {
            soundPool.play(soundExplosion, 1f, 1f, 0, 0, 1.0f);
        }

        new Handler().postDelayed(() -> {
            appleCells[row][col].setBackgroundResource(R.drawable.pineapple_griddestroy);
            isExplosionInProgress = false;
        }, 500); // Ïï†ÎãàÎ©îÏù¥ÏÖò Ï¢ÖÎ£å ÌõÑ ÌîåÎûòÍ∑∏ Ìï¥Ï†ú

        Toast.makeText(GameActivity.this, "üí•Î∏îÎ°ù Ï†úÍ±∞!" + destroyCount + "Í∞ú ÎÇ®Ïùå", Toast.LENGTH_SHORT).show();
    }


    private void handleSwapBlock(int row, int col) {
        if(!isFirstSwapSelected) {
            firstSwapRow = row;
            firstSwapCol = col;
            isFirstSwapSelected = true;

            appleCells[row][col].setBackgroundResource(R.drawable.pineapple_gridselect);

        } else {

            appleCells[row][col].setBackgroundResource(R.drawable.pineapple_gridselect);

            CharSequence temp = appleCells[row][col].getText();
            appleCells[row][col].setText(appleCells[firstSwapRow][firstSwapCol].getText());
            appleCells[firstSwapRow][firstSwapCol].setText(temp);

            swapCount--;
            Toast.makeText(GameActivity.this, "üîÑÎ∏îÎ°ù ÍµêÌôò ÏôÑÎ£å!" + swapCount + "Í∞ú ÎÇ®Ïùå", Toast.LENGTH_SHORT).show();

            new Handler().postDelayed(() -> {
                appleCells[firstSwapRow][firstSwapCol].setBackgroundResource(R.drawable.pineapple_grid);
                appleCells[row][col].setBackgroundResource(R.drawable.pineapple_grid);
            }, 500);

            isFirstSwapSelected = false;
            isSwapMode = false;
        }
    }

    private void updateHintButtonText() {
        if (hintCount > 0) {
            btnHint.setText("ÌûåÌä∏ (" + hintCount + "/3)");
        } else {
            btnHint.setText("ÌûåÌä∏ ÏÇ¨Ïö© Î∂àÍ∞Ä");
            btnHint.setEnabled(false);
            btnHint.setBackgroundColor(Color.GRAY); // ÏÑ†ÌÉùÏÇ¨Ìï≠: ÎπÑÌôúÏÑ±Ìôî ÎäêÎÇå
        }
    }

    private void showHint() {
        clearHighlight(); // Í∏∞Ï°¥ ÌïòÏù¥ÎùºÏù¥Ìä∏ Ï†úÍ±∞

        for (int r1 = 0; r1 < GRID_ROWS; r1++) {
            for (int c1 = 0; c1 < GRID_COLS; c1++) {
                for (int r2 = r1; r2 < GRID_ROWS; r2++) {
                    for (int c2 = c1; c2 < GRID_COLS; c2++) {

                        int sum = 0;
                        for (int row = r1; row <= r2; row++) {
                            for (int col = c1; col <= c2; col++) {
                                String text = appleCells[row][col].getText().toString();
                                if (!text.isEmpty()) {
                                    sum += Integer.parseInt(text);
                                }
                            }
                        }

                        if (sum == 10) {
                            // Í∏àÏÉâ ÌïòÏù¥ÎùºÏù¥Ìä∏Î°ú ÌëúÏãú
                            for (int row = r1; row <= r2; row++) {
                                for (int col = c1; col <= c2; col++) {
                                    appleCells[row][col].setBackgroundColor(Color.parseColor("#FF0000"));
                                }
                            }
                            Toast.makeText(this, "üîç Ìï©Ïù¥ 10Ïù∏ Ï°∞Ìï© Î∞úÍ≤¨!", Toast.LENGTH_SHORT).show();
                            return;
                        }
                    }
                }
            }
        }

        Toast.makeText(this, "‚ùå Í∞ÄÎä•Ìïú Ï°∞Ìï©Ïù¥ ÏóÜÏäµÎãàÎã§!", Toast.LENGTH_SHORT).show();
    }

    private void uploadScoreWithLimit(String nickname, int newScore) {
        DatabaseReference dbRef = FirebaseDatabase.getInstance().getReference("rankings");

        dbRef.addListenerForSingleValueEvent(new ValueEventListener() {
            @Override
            public void onDataChange(@NonNull DataSnapshot snapshot) {
                List<DataSnapshot> entries = new ArrayList<>();
                for (DataSnapshot child : snapshot.getChildren()) {
                    entries.add(child);
                }

                // 10Í∞ú ÎØ∏ÎßåÏù¥Î©¥ Í∑∏ÎÉ• Ï†ÄÏû•
                if (entries.size() < 10) {
                    saveScore(dbRef, nickname, newScore);
                } else {
                    // ÏµúÏ†Ä Ï†êÏàò Ï∞æÍ∏∞
                    DataSnapshot lowestSnapshot = null;
                    int minScore = Integer.MAX_VALUE;

                    for (DataSnapshot entry : entries) {
                        Integer score = entry.child("score").getValue(Integer.class);
                        if (score != null && score < minScore) {
                            minScore = score;
                            lowestSnapshot = entry;
                        }
                    }

                    // ÏÉà Ï†êÏàòÍ∞Ä Îçî ÌÅ¨Î©¥ ‚Üí ÏµúÏ†ÄÏ†ê Ï†úÍ±∞ ÌõÑ Ï†ÄÏû•
                    if (newScore > minScore && lowestSnapshot != null) {
                        lowestSnapshot.getRef().removeValue()
                                .addOnSuccessListener(aVoid -> saveScore(dbRef, nickname, newScore));
                    }
                }
            }

            @Override
            public void onCancelled(@NonNull DatabaseError error) {
                Toast.makeText(GameActivity.this, "üî• Îû≠ÌÇπ ÏóÖÎ°úÎìú Ïã§Ìå®", Toast.LENGTH_SHORT).show();
            }
        });
    }
    private void saveScore(DatabaseReference dbRef, String nickname, int score) {
        String key = UUID.randomUUID().toString();

        Map<String, Object> data = new HashMap<>();
        data.put("nickname", nickname);
        data.put("score", score);
        data.put("timestamp", System.currentTimeMillis());

        dbRef.child(key).setValue(data)
                .addOnSuccessListener(aVoid ->
                        Toast.makeText(GameActivity.this, "‚úÖ Ï†êÏàò Ï†ÄÏû• ÏôÑÎ£å!", Toast.LENGTH_SHORT).show()
                )
                .addOnFailureListener(e ->
                        Toast.makeText(GameActivity.this, "‚ùå Ï†ÄÏû• Ïã§Ìå®: " + e.getMessage(), Toast.LENGTH_SHORT).show()
                );
    }
    @Override
    protected void onDestroy() {
        super.onDestroy();
        if (soundPool != null) {
            soundPool.release();
            soundPool = null;
        }
    }

}